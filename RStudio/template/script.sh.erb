#!/usr/bin/env bash

#shellcheck source=before.sh.erb

## The version of R to run according to OnDemand form.
## Environment variable 'ONDEMAND_R_VERSION' is optional.
## If set, it should specify one of the available R version
## in the CBI stack.  If not set, or "default", then it will
## use Lmod's default version of R.
##
## To find available R version for form.yml, use:
##
##   module purge
##   module load CBI
##   r_versions=($(ls -1 "$MODULE_ROOT_CBI"/r/ | grep -E "^([[:digit:]]+|[.])+[.]lua$" | sed 's/.lua//' | sort -u | sort -h -r))
##   printf '      - ["%s"]\n' "${r_versions[@]}"
## 
if [[ ${r_version} == "default" ]]; then
    r_version=""
fi

module load CBI
module load r/"${r_version}"
module load rstudio-server-controller

# Start RSC launching the personal Rstudio Server instance
rsc start --port="${port:?}"
